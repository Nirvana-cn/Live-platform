<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="app">
    <div class="wrapper" v-show="flag">
        <button @click="beginLive">发起直播</button>
        <button @click="watchLive">观看直播</button>
    </div>
    <p v-show="online">主播暂时不在家</p>
    <br>
    <video id="live" autoplay></video>
</div>
</body>
<script>
    var socket = io.connect()
    var anchor, remote, watcher, userName
    var app = new Vue({
        el: '#app',
        data: {
            flag: true,
            online: true
        },
        methods: {
            beginLive() {
                this.flag = false
                userName = 'live'
                var constraints = {audio: false, video: {width: 640}}
                navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
            },
            watchLive() {
                this.flag = false
                watcher = new RTCPeerConnection()
                watcher.setRemoteDescription(remote).then(createAnswer)
            }
        }
    })

    function handleSuccess(stream) {
        document.getElementById("live").srcObject = stream
        anchor = new RTCPeerConnection()
        anchor.createOffer().then((offer) => {
            anchor.setLocalDescription(offer)
        }).then(sendLiveOffer)
    }

    function handleError(error) {
        console.log(error)
    }

    function sendLiveOffer() {
        socket.emit('live', anchor.localDescription)
    }


    //    watcher code
    function createAnswer() {
        watcher.createAnswer().then((answer) => {
            watcher.setLocalDescription(answer)
        }).then(sendAnswer)
    }

    function sendAnswer() {
        socket.emit('watcher', watcher.localDescription)
    }

    socket.on('welcome', function (data) {
        remote = data
        console.log('receive ' + data)
    })

    socket.on('watcherAnswer', function (data) {
        if (userName === 'live') {
            anchor.setRemoteDescription(data).then(()=>{console.log('connect success')})
        }
    })
</script>
</html>