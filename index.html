<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="app">
    <div class="login" v-show="flag">
        <p>观看直播前，请输入您的昵称</p>
        <input type="text" v-model="userName">
        <button @click="sendName">提交昵称</button>
        <p v-show="remind">昵称中不能含有任何空白字符，包括空格、制表符</p>
    </div>
    <div class="wrapper" v-show="!flag">
        <p>直播页</p>
        <p v-show="online">主播目前不在线</p>
        <video id="video" autoplay></video>
    </div>
</div>
</body>
<script>
    var socket = io.connect()
    var anchor=new Map(), watcher,watcherID,localStream
    var app = new Vue({
        el: '#app',
        data: {
            flag: true,
            remind: false,
            online: false,
            userName: ''
        },
        methods: {
            sendName() {
                var that = this
                console.log(this.userName)
                if (this.userName !== '' && this.userName.search(' ') == -1) {
                    socket.emit('userName', that.userName, function (data) {
                        if (data) {
                            that.flag = false
                        } else {
                            alert('对不起，您输入的用户名已存在，请重新输入！')
                        }
                    })
                } else {
                    this.remind = true
                }
            }
        }
    })

    socket.on('live', function () {
        console.log('主播上线了')
        var mobile = {
            audio: false,
            video: {
                mandatory: {
                    maxWidth: 640,
                    maxHeight: 360
                }
            }
        }
        var desktop = {
            audio: false,
            video: {
                mandatory: {
                    maxWidth: 1280,
                    maxHeight: 720
                }
            }
        }
        var constraints
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|OperaMini/i.test(navigator.userAgent)) {
            constraints = mobile
        } else {
            constraints = desktop
        }
        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError)
    })

    socket.on('addWatcher', function (data) {
        console.log('有新的观看者')
        let watcherID=data
        anchor.set(watcherID,new RTCPeerConnection())
        anchor.get(watcherID).addStream(localStream)
        anchor.get(watcherID).createOffer().then((offer) => {
            anchor.get(watcherID).setLocalDescription(offer)
        }).then(sendLiveOffer(watcherID))
        anchor.get(watcherID).onicecandidate = function (event) {
            if (event.candidate) {
                socket.emit('anchorIce', {'ice':event.candidate,'target':watcherID})
            }
        }
    })

    function handleSuccess(stream) {
        document.getElementById("video").srcObject = stream
        localStream=stream
    }

    function handleError(error) {
        console.log('There is an error: ' + error)
    }

    function sendLiveOffer(id) {
        socket.emit('sendOffer', {
            name: 'anchor',
            target: id,
            type: "video-offer",
            sdp: anchor.get(id).localDescription
        })
    }

    socket.on('watcherAnswer', function (data) {
        var desc = new RTCSessionDescription(data.sdp)
        anchor.get(data.name).setRemoteDescription(desc).then(() => {
            console.log('PeerConnection success')
        })
    })

    socket.on('receiveWatcherIce', function (data) {
        anchor.get(data.name).addIceCandidate(new RTCIceCandidate(data.ice))
    })

    socket.on('watcherLeave', function (data) {
        anchor.get(data).onicecandidate = null
        anchor.get(data).onaddstream = null
        anchor.get(data).close()
        anchor.set(data,null)
    })

    //    watcher code
    socket.on('watch', function (data) {
        console.log('观看直播中')
        watcher = new RTCPeerConnection()
        watcher.onaddstream = function (e) {
            document.getElementById("video").srcObject = e.stream
            console.log('add stream success')
        }
        watcher.onicecandidate = function (event) {
            if (event.candidate) {
                socket.emit('watcherIce', {'ice':event.candidate,name:watcherID})
            }
        }
        let desc = new RTCSessionDescription(data.sdp)
        watcher.setRemoteDescription(desc).then(createAnswer)
    })

    socket.on('receiveAnchorIce', function (data) {
        console.log(data)
        if(data){
            watcher.addIceCandidate(new RTCIceCandidate(data))
        }
    })

    socket.on('welcome', function (data) {
        watcherID=data
    })

    function createAnswer() {
        watcher.createAnswer().then((answer) => {
            watcher.setLocalDescription(answer).then(sendAnswer)
        })
    }

    function sendAnswer() {
        socket.emit('sendAnswer', {
            name: watcherID,
            target: 'anchor',
            type: 'video-answer',
            sdp: watcher.localDescription
        })
    }
</script>
</html>