<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="app">
    <div class="wrapper" v-show="flag">
        <button @click="beginLive">发起直播</button>
        <button @click="watchLive">观看直播</button>
    </div>
    <p v-show="online">主播暂时不在家</p>
    <br>
    <video id="live" autoplay></video>
</div>
</body>
<script>
    var socket = io.connect()
    var myHostname = window.location.hostname
    var anchor, remote, watcher, userName
    var app = new Vue({
        el: '#app',
        data: {
            flag: true,
            online: true
        },
        methods: {
            beginLive() {
                this.flag = false
                userName = 'live'
                var constraints = {
                    audio: false,
                    video: {
                        mandatory: {
                            minWidth: 640,
                            minHeight: 480
                        }
                    }
                }
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|OperaMini/i.test(navigator.userAgent)) {
                    constraints = {
                        audio: false,
                        video: {
                            mandatory: {
                                minWidth: 480,
                                minHeight: 320,
                                maxWidth: 1024,
                                maxHeight: 768
                            }
                        }
                    }
                }
                navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
            },
            watchLive() {
                this.flag = false
                watcher = new RTCPeerConnection({
                    iceServers: [
                        {
                            urls: "turn:" + myHostname,
                            username: "webrtc",
                            credential: "turnserver"
                        }
                    ]
                })
                let desc = new RTCSessionDescription(remote.sdp)
                watcher.setRemoteDescription(desc).then(createAnswer)

            }
        }
    })

    function handleSuccess(stream) {
        document.getElementById("live").srcObject = stream
        anchor = new RTCPeerConnection({
            iceServers: [
                {
                    urls: "turn:" + myHostname,
                    username: "webrtc",
                    credential: "turnserver"
                }
            ]
        })
        anchor.createOffer().then((offer) => {
            anchor.setLocalDescription(offer)
        }).then(sendLiveOffer)
        return anchor.addStream(stream)
    }

    function handleError(error) {
        console.log('There is an error: ' + error)
    }

    function sendLiveOffer() {
        socket.emit('live', {
            name: userName,
            target: 'watcher',
            type: "video-offer",
            sdp: anchor.localDescription
        })
    }

    socket.on('watcherAnswer', function (data) {
        if (userName === 'live') {
            let desc = new RTCSessionDescription(data.sdp)
            anchor.setRemoteDescription(desc).then(() => {
                console.log('PeerConnection success')
            })
        }
    })

    //    watcher code
    function createAnswer() {
        watcher.createAnswer().then((answer) => {
            watcher.setLocalDescription(answer).then(sendAnswer)
        })
    }

    function sendAnswer() {
        socket.emit('watcher', {
            name: 'watcher',
            target: 'live',
            type: 'video-answer',
            sdp: watcher.localDescription
        })
    }

    socket.on('welcome', function (data) {
        remote = data
        console.log('receive ' + remote)
    })
</script>
</html>